<!DOCTYPE html>
<html lang="{{request.locale_name}}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="{{request.static_url('back:static/pyramid-16x16.png')}}">

    <title>COVID-19 Tracker</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>

    <style>
        #mapid { height: 500px; }
    </style>
    <!-- Custom styles for this scaffold -->
    <!--<link href="{{request.static_url('back:static/theme.css')}}" rel="stylesheet">-->

    <!-- HTML5 shiv and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js" integrity="sha384-0s5Pv64cNZJieYFkXYOTId2HMA2Lfb6q2nAcx2n0RTLUnCAoTTsS0nKEO27XyKcY" crossorigin="anonymous"></script>
      <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js" integrity="sha384-ZoaMbDF+4LeFxg6WdScQ9nnR1QC2MIRxA1O9KWEXQwns1G8UNyIEZIQidzb0T1fo" crossorigin="anonymous"></script>
    <![endif]-->
  </head>

  <body>
    <!-- START language selector -->
    <div class="float-right">
      Language:&nbsp;
      <select id="language" data-toggle="tooltip" title="Uses a cookie to store the selected language.">{{ _("use_my_location") }}>
        {% for l in request.registry.settings.get('available_locales').split(' ') %}
          {% if l == request.locale_name %}
            <option value="{{ l }}" selected>{{ l }}</option>
          {% else %}
            <option value="{{ l }}">{{ l }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>
    <!-- END language selector -->

    {% block content %}
        <p>No content</p>
    {% endblock content %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin=""></script>

    <script>
    var map = L.map('mapid');
    var markers = {};

    // London
    var default_location = [51.505, -0.09]

    var initial_lat = window.localStorage.getItem('lat') || default_location[0];
    var initial_lon = window.localStorage.getItem('lon') || default_location[1];

    map.setView([initial_lat, initial_lon], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(map);


    $.getJSON("/list-markers", function( data ) {
      $.each( data, function( key, val ) {
        markers[val.id] = add_map_marker(map, val)
      });
    });


    $("#use-my-location").click(function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position){
            window.localStorage.setItem('lat', position.coords.latitude)
            window.localStorage.setItem('lon', position.coords.longitude)
            map.panTo(new L.LatLng(position.coords.latitude, position.coords.longitude));
          },
          function(e) {console.log(e)}
        );
      };
    });


    function add_map_marker(map, val) {
      color = 'red'
      if(val.owned) {
        color = 'blue'
      }

      var circle = L.circle([val.lat, val.lon], {
          color: color,
          fillColor: '#f03',
          fillOpacity: 0.5,
          radius: 20
        }).addTo(map);

      var popup = val.reported_date + " <b>" + val.name + "</b><br/><br/>" + val.note;

      if(val.owned) {
        popup = popup + '<br/><a href="javascript:;" class="remove-marker" data-marker-id="' + val.id +'">Delete marker</a>';
      };

      circle.bindPopup(popup);
      return circle;
    };


    $(document).on('click', '.remove-marker', function (e) {
      $.ajax({
        url: '/remove-marker/' + $(this).data('marker-id'),
        type: 'POST',
        success: function( data ) {
          marker_id = parseInt(e.target.getAttribute("data-marker-id"));
          console.log(markers[marker_id]);
          map.removeLayer(markers[marker_id]);
          delete markers[marker_id];
        },
        error: function( xhr, err ) {
          alert(err);
        }
      });
  });

  </script>
  <script type="text/javascript" src="{{request.static_url('back:static/main.js')}}"></script>
    {% block bottom_js %}
    {% endblock %}
  </body>
</html>
